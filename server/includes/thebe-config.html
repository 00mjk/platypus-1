<script type="text/x-thebe-config">{
  requestKernel: true,
  binderOptions: {
    repo: "qiskit-community/qiskit-textbook",
    ref: "platypus-binder",
  },
  codeMirrorconfig: {
    lineWrapping: false
  },
  codeMirrorConfig: {
    theme: "abcdef",
    mode: "python"
  },
  kernelOptions: {
    kernelName: "python3",
    path: "./notebooks/intro"
  },
  mathjaxUrl: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js',
  predefinedOutput: true,
  outputSelector: '[data-executable-output]'
}
</script>

<script defer>
  const thebelabBootstrap = function () {
    thebelab.bootstrap()
    thebelab.on("status", function (evt, data) {
      console.log("Thebelab status changed:", data.status, data.message)
      if (data.status ===  "ready") {
        document.querySelectorAll('.thebelab-cell').forEach(cell => {
          // based on: https://jcubic.wordpress.com/2017/09/22/how-get-jquery-data-without-jquery/
          setTimeout(() => {
            const jQueryData = Object.keys(cell).filter(key => key.match(/^jQuery/)).map(key => cell[key])[0]
            const kernel = jQueryData.kernel;
            const oldHandle = kernel._handleMessage
            kernel._handleMessage = (e) => {
              oldHandle(arguments);
              if (e.msg_type && e.msg_type === "execute_input") {
                cell.querySelector(".thebelab-run-button").textContent = 'Running...'
              }
              if (e.msg_type && e.msg_type === "execute_reply") {
                cell.querySelector(".thebelab-run-button").textContent = 'Run'
              }
            }
          }, 1000)
          // execute_reply execute_input
        })
      }
    })
    document
      .querySelectorAll('.thebelab-cell')
      .forEach(codeCell => {
        codeCell.querySelector('.thebelab-restart-button').remove()

        const codeCellRunButton = codeCell.querySelector('.thebelab-run-button')
        codeCellRunButton.setAttribute('data-test', 'code-cell-button-run')
        codeCellRunButton.textContent = 'Run'

        codeCell.setAttribute('data-test', 'code-cell')

        codeCell
          .querySelector('.thebelab-input')
          .setAttribute('data-test', 'code-cell-input')

        codeCell
          .querySelector('.jp-OutputArea')
          .setAttribute('data-test', 'code-cell-output')
          
        codeCell
          .querySelector('.CodeMirror-code')
          .setAttribute('data-test', 'code-cell-code')
      })

    /**
     * Copy to clipboard functionality.
     */
    document
      .querySelectorAll('.thebelab-cell')
      .forEach((thebelabCell, index) => {
        const codeCellId = `code-mirror-element-${index}`

        const clipboardCopyComponent = document.createElement(
          'q-code-mirror-clipboard-copy'
        )
        clipboardCopyComponent.setAttribute('target-id', codeCellId)
        thebelabCell.append(clipboardCopyComponent)

        const codeInput = document.createElement('input')
        codeInput.id = codeCellId
        thebelabCell.append(codeInput)

        /**
         * Create a copy of the CodeMirror cell's content adding line breaks.
         * The "copy to clipboard" functionality will copy the content from this
         * copy.
         */
        const codeElement = thebelabCell.querySelector('.CodeMirror-code')
        const codeLines = Array.from(
          codeElement.querySelectorAll('.CodeMirror-line')
        ).map(codeLine => codeLine.textContent)
        const formattedCode = codeLines.join('\n')
        codeInput.setAttribute('type', 'hidden')
        codeInput.setAttribute('value', formattedCode)
      })
  }

  // check if Thebelab needs to be loaded
  if (document.querySelector("[data-executable]")) {
    /**
     * Thebelab loads "reset CSS" after the theme styles load and so,
     * it invalidates part of the theme rules. To make the theme CSS to take
     * the correct precedence, we listen for Thebelab to finish loading, then
     * relocate the theme CSS and start Thebelab.
     */
    const thebelabScript = document.createElement('script');
    thebelabScript.src = "https://unpkg.com/thebelab@latest/lib/index.js"
    thebelabScript.async = true
    thebelabScript.onload = () => {
      setTimeout(() => {
        document.head.append(
          ...document.querySelectorAll('[data-style]')
        )
      })

      window.textbook.runAfterDOMLoaded(thebelabBootstrap)
    }
    document.head.append(thebelabScript);
  }
</script>
